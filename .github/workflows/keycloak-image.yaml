name: Keycloak Image Builder

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Keycloak target version (e.g., 25.0.2-debian-12-r2)'
        required: true
        default: '25.0.2-debian-12-r2'
  push:
    branches:
      - main
      # - feat/**

jobs:
  build-keycloak-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set target version
        run: |
          echo "target_version=${{ github.event.inputs.target_version || '25.0.2-debian-12-r2' }}" >> $GITHUB_ENV
          echo "Using target_version=${{ env.target_version }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone Bitnami containers repository
        run: |
          git clone https://github.com/bitnami/containers.git /tmp/bitnami-containers
          cd /tmp/bitnami-containers

      - name: Find commit for version
        run: |
          cd /tmp/bitnami-containers
          
          COMMIT_HASH=$(git log --oneline --grep="keycloak.*${{ env.target_version }}" --all | head -n 1 | cut -d' ' -f1)
          
          if [ -z "$COMMIT_HASH" ]; then
            echo "Error: Could not find commit for version ${{ env.target_version }}"
            exit 1
          fi
          
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "Found commit: $COMMIT_HASH"
          echo "Commit message: $(git log --format=%B -n 1 $COMMIT_HASH)"

      - name: Checkout commit and navigate to directory
        run: |
          cd /tmp/bitnami-containers
          git checkout ${{ env.COMMIT_HASH }}
          
          cd bitnami/keycloak
          
          MAJOR_VERSION=$(echo "${{ env.target_version }}" | cut -d. -f1)
          VERSION_DIR=$(find . -maxdepth 1 -type d -name "${MAJOR_VERSION}*" | head -n 1)
          
          if [ -z "$VERSION_DIR" ]; then
            echo "Error: Could not find version directory for ${{ env.target_version }}"
            echo "Available directories:"
            ls -d */
            exit 1
          fi
          
          echo "VERSION_DIR=$VERSION_DIR" >> $GITHUB_ENV
          cd "$VERSION_DIR"
          
          OS_DIR=$(find . -maxdepth 1 -type d \( -name "debian*" -o -name "rhel*" -o -name "ubuntu*" \) | head -n 1)
          
          if [ -z "$OS_DIR" ]; then
            echo "Error: Could not find OS directory"
            echo "Available directories:"
            ls -d */
            exit 1
          fi
          
          echo "OS_DIR=$OS_DIR" >> $GITHUB_ENV
          cd "$OS_DIR"
          
          if [ ! -f "Dockerfile" ]; then
            echo "Error: Dockerfile not found in $(pwd)"
            exit 1
          fi
          
          echo "BUILD_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Build and push Docker image
        run: |
          cd ${{ env.BUILD_DIR }}
          echo "Building Docker image from $(pwd)..."
          
          docker build \
            -t ghcr.io/${{ github.repository_owner }}/images/images/keycloak:${{ env.target_version }} .
          
          docker push ghcr.io/${{ github.repository_owner }}/images/images/keycloak:${{ env.target_version }}

      - name: Cleanup
        run: rm -rf /tmp/bitnami-containers