name: Build keycloak ocm component
on:
  workflow_dispatch:
    inputs:
      imageVersion:
        description: "Keycloak image version (semantic version for component)"
        required: false
        type: string
        default: 26.5.2
      imageTag:
        description: "Keycloak image tag (full tag for pulling image)"
        required: false
        type: string
        default: 26.5.2-debian-12-r0
      chartVersion:
        description: "Keycloak chart version"
        required: false
        type: string
        default: 25.3.0
      imageSourceCommit:
        description: "Commit SHA from bitnami/containers for image source"
        required: false
        type: string
        default: "411bc7189c51ca61415abecaf1be8ab13ab24592"
      chartSourceCommit:
        description: "Commit SHA from bitnami/charts for chart source"
        required: false
        type: string
        default: "b1afd5e96c71bbf2fa5ee10d23ca0d7d958fe3a9"
      chartOCIPackagePath:
        required: false
        type: string
        description: "OCI registry path for chart in GHCR"
        default: ghcr.io/platform-mesh/upstream-images/charts/keycloak
      imageOCIPackagePath:
        required: false
        type: string
        description: "OCI registry path for image in GHCR"
        default: ghcr.io/platform-mesh/upstream-images/keycloak
      keycloakPostgresqlImageVersion:
        description: "Keycloak PostgreSQL image version"
        required: false
        type: string
        default: 17.6.0-debian-12-r4
      componentName:
        required: false
        type: string
        description: "Component name"
        default: github.com/platform-mesh/keycloak
      dryRun:
        required: false
        type: boolean
        description: "Dry run mode - skip pushing to OCM registry"
        default: true

permissions:
  contents: read
  packages: write

jobs:
  ocm:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      COMPONENT_NAME: ${{ inputs.componentName }}
      COMPONENT_CONSTRUCTOR_FILE: '.ocm/component-constructor-keycloak.yaml'
      OCM_REGISTRY_URL: 'ghcr.io/platform-mesh'
    
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup OCM CLI
        run: |
          REPO=${repo:=open-component-model/ocm}
          if [ -z "$version" -o "$version" == latest ]; then
            version="$(basename "$(curl -Ls -o /dev/null -w %{url_effective} https://github.com/$REPO/releases/latest)")"
            echo "Selecting latest version: $version"
          fi
          VERSION=${version#v}
          ARCHIVE_FILE="ocm-${VERSION}-linux-amd64.tar.gz"
          URL="https://github.com/$REPO/releases/download/v${VERSION}/$ARCHIVE_FILE"
          echo "Installing ocm-cli version $version from $REPO"
          curl -LsS -o ocm-cli.tgz "$URL"
          tar --overwrite -xvzf ocm-cli.tgz >/dev/null
          chmod a+x ocm

      - name: Write Credentials file
        run: |
          cat <<EOF > $HOME/.ocmconfig
            type: generic.config.ocm.software/v1
            configurations:
              - type: credentials.config.ocm.software
                consumers:
                  - identity:
                      type: OCIRegistry
                      scheme: https
                      hostname: ghcr.io
                      pathprefix: platform-mesh
                    credentials:
                      - type: Credentials
                        properties:
                          username: github
                          password: ${{ secrets.GITHUB_TOKEN }}
          EOF

      - name: Create OCM ComponentArchive
        run: |
          ocm_ctf=.ocm/transport.ctf
          mkdir -p "$(dirname "$ocm_ctf")"
          ./ocm add components -c --templater=go --file "$ocm_ctf" "${{ env.COMPONENT_CONSTRUCTOR_FILE }}" -- \
            IMAGE_VERSION=${{ inputs.imageVersion }} \
            IMAGE_TAG=${{ inputs.imageTag }} \
            IMAGE_NAME=${{ inputs.imageOCIPackagePath }} \
            IMAGE_SOURCE_COMMIT=${{ inputs.imageSourceCommit }} \
            CHART_VERSION=${{ inputs.chartVersion }} \
            CHART_SOURCE_COMMIT=${{ inputs.chartSourceCommit }} \
            COMPONENT_NAME=${{ env.COMPONENT_NAME }} \
            KEYCLOAK_POSTGRESQL_IMAGE_VERSION=${{ inputs.keycloakPostgresqlImageVersion }} \
            CHART_OCI_PATH=${{ inputs.chartOCIPackagePath }}

      - name: Print OCM Component
        run: ./ocm get components -o yaml .ocm/transport.ctf

      - name: Transfer to OCM REPO
        if: ${{ inputs.dryRun != true }}
        run: ./ocm transfer ctf --overwrite .ocm/transport.ctf "${{ env.OCM_REGISTRY_URL }}"